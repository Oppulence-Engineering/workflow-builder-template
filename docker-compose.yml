# =============================================================================
# Docker Compose - Development Environment
# =============================================================================
# Complete development environment for Workflow Builder with:
# - Next.js application with Platformatic Watt (hot reload)
# - PostgreSQL database
# - Valkey (Redis-compatible) for distributed caching
# =============================================================================
# Usage:
#   Start:  docker-compose up
#   Stop:   docker-compose down
#   Logs:   docker-compose logs -f app
#   Clean:  docker-compose down -v --remove-orphans
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Next.js Application with Platformatic Watt
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: workflow-builder-dev
    ports:
      # Application port
      - "8000:8000"
      # Metrics port (Prometheus)
      - "9090:9090"
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Prevent overwriting node_modules with host version
      - /app/node_modules
      # Persist Next.js cache between restarts
      - nextjs_cache:/app/.next
    environment:
      # Database connection (uses Docker service name)
      - DATABASE_URL=postgresql://workflow:workflow@postgres:5432/workflow_builder
      # Better Auth configuration
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-dev-secret-change-in-production}
      - BETTER_AUTH_URL=http://localhost:8000
      # Platformatic Watt configuration
      - PORT=8000
      - PLT_NEXT_WORKERS=1
      - PLT_VALKEY_HOST=valkey:6379
      - PLT_SERVER_LOGGER_LEVEL=debug
      # Integration encryption key
      - INTEGRATION_ENCRYPTION_KEY=${INTEGRATION_ENCRYPTION_KEY:-dev-encryption-key-32chars}
      # Optional: AI Gateway
      - AI_GATEWAY_API_KEY=${AI_GATEWAY_API_KEY:-}
      # Optional: OAuth providers
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      # Node environment
      - NODE_ENV=development
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    networks:
      - workflow-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: workflow-postgres
    ports:
      # Expose for local database tools (e.g., pgAdmin, DBeaver)
      # Using 5433 to avoid conflicts with local PostgreSQL
      - "5433:5432"
    environment:
      - POSTGRES_USER=workflow
      - POSTGRES_PASSWORD=workflow
      - POSTGRES_DB=workflow_builder
    volumes:
      # Persist database data
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U workflow -d workflow_builder"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - workflow-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Valkey (Redis-compatible) for Distributed Caching
  # ---------------------------------------------------------------------------
  valkey:
    image: valkey/valkey:latest
    container_name: workflow-valkey
    ports:
      # Expose for local Redis tools (e.g., RedisInsight)
      # Using 6380 to avoid conflicts with local Redis
      - "6380:6379"
    volumes:
      # Persist cache data (optional for development)
      - valkey_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - workflow-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Lead Scraper Service
  # ---------------------------------------------------------------------------
  lead-scraper:
    image: ghcr.io/oppulence-engineering/oppulence-leads-scraper:latest
    container_name: lead-scraper
    platform: linux/amd64
    environment:
      DATABASE_URL: postgres://postgres:postgres@lead-scraper-db:5432/postgres?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      SERVICE_NAME: vector-leads-scraper
      ENVIRONMENT: development
      LOG_LEVEL: info
      NEW_RELIC_LICENSE_KEY: "0000000000000000000000000000000000000000"
    command:
      [
        "-grpc",
        "-grpc-port",
        "50051",
        "-gateway",
        "-gateway-addr",
        ":8080",
        "-redis-enabled",
        "-redis-url",
        "redis://redis:6379/0",
        "-redis-workers",
        "10",
        "-db-url",
        "postgres://postgres:postgres@lead-scraper-db:5432/postgres?sslmode=disable",
        "-service-name",
        "vector-leads-scraper",
        "-environment",
        "development",
        "-addr",
        "0.0.0.0",
        "-log-level",
        "info",
        "-c",
        "8",
        "-metrics-reporting-enabled=false",
        "-newrelic-key",
        "0000000000000000000000000000000000000000",
      ]
    depends_on:
      lead-scraper-db:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "50051:50051"
      - "8081:8080"
    networks:
      - workflow-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Lead Scraper PostgreSQL Database
  # ---------------------------------------------------------------------------
  lead-scraper-db:
    image: postgres:15-alpine
    container_name: lead-scraper-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - lead_scraper_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - workflow-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Redis for Lead Scraper
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: lead-scraper-redis
    ports:
      - "6381:6379"
    volumes:
      - lead_scraper_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - workflow-network
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  workflow-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  valkey_data:
    driver: local
  nextjs_cache:
    driver: local
  lead_scraper_postgres_data:
    driver: local
  lead_scraper_redis_data:
    driver: local
