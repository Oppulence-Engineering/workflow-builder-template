# =============================================================================
# Development Dockerfile for Workflow Builder
# =============================================================================
# Optimized for development with hot reload support via Platformatic Watt
# Use with docker-compose.yml for full development environment
# =============================================================================

FROM node:22-alpine

# Install system dependencies
# - netcat-openbsd: for health check scripts
# - curl: for debugging and health checks
RUN apk add --no-cache netcat-openbsd curl

# Install pnpm globally
RUN npm install -g pnpm

# Set working directory
WORKDIR /app

# Set development environment
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# Default port configuration for development
ENV PORT=8000
ENV PLT_NEXT_WORKERS=1
ENV PLT_SERVER_LOGGER_LEVEL=debug

# Copy package files first for better layer caching
COPY package.json pnpm-lock.yaml ./

# Install all dependencies (including devDependencies)
RUN pnpm install --frozen-lockfile

# Copy Watt configuration
COPY watt.json ./

# Copy entrypoint script
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Note: Source code is mounted as a volume in docker-compose.yml
# This allows hot reload to work correctly

# Expose application port and metrics port
EXPOSE 8000 9090

# Use entrypoint script for migrations and startup
ENTRYPOINT ["/docker-entrypoint.sh"]

# Default command: start development server
CMD ["pnpm", "dev"]


